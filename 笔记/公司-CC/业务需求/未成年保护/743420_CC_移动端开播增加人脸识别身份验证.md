# #743420 CC 移动端开播增加人脸识别身份验证

实名查询接口：[https://innerapi.dev.cc.163.com/inner/v1/realname/info?uids=21343281](https://innerapi.dev.cc.163.com/inner/v1/realname/info?uids=21343281)

人脸验证后台：[https://tianshu.aman-dev.netease.com/#/home/280](https://tianshu.aman-dev.netease.com/#/home/280)

**遇到的问题**

调用sdk进行人脸检测，内部通过AsyncTask访问网络，尝试验证network-security-config等原因未果，后发现有些机型无法执行AsyncTask，排查发现是项目中有个后台服务会一直占用着线程，导致阻塞，无空余线程再执行AsyncTask

一、PC开播工具扫码流程

扫码得到cclink，跳转FaceDetectActivity

- 未登录-前往登录，登录后跳到第二步
- 人脸验证弹窗提示-同意：获取token，拿到token调用sdk，finish
- finish

cclink：[cc://gl_face_detect?uid=](cc://gl_face_detect/?uid=)

```
1.未登录、登录账号不一致、顶号等逻辑要考虑
2.透明activity可以增加点击后finish，避免遗漏销毁场景
```

二、移动端开播检查流程、手游开播流程

开播前请求是否进行人脸验证

- 去验证弹窗，点击跳转FaceDetectActivity
    - 人脸验证弹窗提示-同意：获取token，拿到token调用sdk，finish
        - 成功-直接开播
        - 失败-弹窗提示
            - 重新验证，跳转FaceDetectActivity，关闭弹窗
            - 我已了解，关闭弹窗
    - 人脸验证弹窗提示-暂不：finish
- 关闭：无法开播

开播中监听是否要进行人脸验证

- 通知消息，若在后台点击返回前台，若在前台不做表现
- 关闭直播去验证：关闭直播，跳转FaceDetectActivity
    - 人脸验证弹窗提示-同意：获取token，拿到token调用sdk，finish
    - 人脸验证弹窗提示-暂不：finish
- 300s后自动关闭，是否倒计时，点击外部是否可关闭？

相关代码

```
com.netease.cc.mobilelive.mlive.facedetect.MLiveCCFaceDetectHelper
com.netease.cc.mobilelive.mlive.facedetect.FaceDetectRemindDialog
```

（1）倒计时实现

```
private var disposable: Disposable? = null

disposable = Observable.interval(1, TimeUnit.SECONDS)
    .observeOn(AndroidSchedulers.mainThread())
    .subscribe({ count ->
        val remainingTime = countDown - count
        if (remainingTime > 0) {
            // 更新 UI，例如更新文本或进度条
            tvCountDown.text = "*直播将在${remainingTime}s后断开"
        } else {
            disAgree()
            dismissAndDisposable()
        }
    }, {
        CLog.w(tag, "$it")
    })

disposable?.dispose()
```

（2）通知实现

通过下面这个代码发送Notification后，在广播接收器NotificationReceiver中会处理VALUE_BACK_FRONT类型消息，会将当前应用返回前台；

原理是 桌面其实也是一个Activity，将应用Activity放在桌面Activity之上

```
/**
* 简单的通知
* 点击表现：应用处于前台：不做任何事；处于后台：返回前台
*/
public static void showSimpleNotification(Context context, String title, String content) {
    int notifyId = NotificationUtil
        .generateNotifyId(NotificationConstants.COMMON_NOTIFY_ID, true);
    Intent intent = new Intent(IntentConstants.INTENT_NOTIFICATION);
    intent.putExtra(KEY_FROM_NOTIFICATION, Constants.VALUE_BACK_FRONT);
    PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, intent,
        PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);
    Notification notification = NotificationUtil.obtainNotification(context, ID_MSG,
        title,
        content,
        pendingIntent, null, 0, false);
    notification.flags |= Notification.FLAG_AUTO_CANCEL;
    NotificationManager notificationManager = (NotificationManager) context
        .getSystemService(Context.NOTIFICATION_SERVICE);
    notificationManager.notify(notifyId, notification);
}

==============
case Constants.VALUE_BACK_FRONT: {
    if (!DeviceInfo.isForegroundRunning(ApplicationWrapper.getContext())) {
        moveTaskToFront();
    }
    return;
}
==============
private static void moveTaskToFront() {
    ActivityManager am = (ActivityManager) ApplicationWrapper.getTopActivity()
        .getSystemService(Context.ACTIVITY_SERVICE);
    if (am != null && ApplicationWrapper.getTopActivity() != null) {
        am.moveTaskToFront(ApplicationWrapper.getTopActivity().getTaskId(),
            ActivityManager.MOVE_TASK_WITH_HOME);
    }
}
```

（3）服务端数据mock

```
44159/1
开播后触发
{
  "countdown": 300,
  "verify_face": 1
}
```

---

|需求名称 |#743310 PC 开播工具增加人脸识别验证 - Android [https://icc.pm.netease.com/v6/issues/743310](https://icc.pm.netease.com/v6/issues/743310)

#743420 CC 移动端开播增加人脸识别身份验证 [https://icc.pm.netease.com/v6/issues/743420](https://icc.pm.netease.com/v6/issues/743420)
                                                                                                                                                                                                                                                                                                                                                |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|分支     |CC：#743310_faceId                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|需求文档 |[https://docs.popo.netease.com/team/pc/east/pageDetail/5804cb7ef2d74d9eb4e20224c78b4106](https://docs.popo.netease.com/team/pc/east/pageDetail/5804cb7ef2d74d9eb4e20224c78b4106)                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|交互稿   |[https://www.figma.com/file/LHgPfmE4PhaDtMUYNn9U5i/%23741394-%E3%80%90%E4%BA%A4%E4%BA%92%E3%80%91%E6%9C%AA%E6%88%90%E5%B9%B4%E4%BA%BA%E7%BD%91%E7%BB%9C%E4%BF%9D%E6%8A%A4%E6%9D%A1%E4%BE%8B-%EF%BC%882024%E5%B9%B41%E6%9C%881%E6%97%A5%EF%BC%89?type=design&node-id=876-1866&mode=design&t=NLxyDSKYBNM5rhnq-0](https://www.figma.com/file/LHgPfmE4PhaDtMUYNn9U5i/%23741394-%E3%80%90%E4%BA%A4%E4%BA%92%E3%80%91%E6%9C%AA%E6%88%90%E5%B9%B4%E4%BA%BA%E7%BD%91%E7%BB%9C%E4%BF%9D%E6%8A%A4%E6%9D%A1%E4%BE%8B-%EF%BC%882024%E5%B9%B41%E6%9C%881%E6%97%A5%EF%BC%89?type=design&node-id=876-1866&mode=design&t=NLxyDSKYBNM5rhnq-0)|
|UI稿     |人脸识别：[https://www.figma.com/file/rMjzULLR9vyCy8nbwYo1g5/%23742320-%E6%9C%AA%E6%88%90%E5%B9%B4%E4%BA%BA%E7%BD%91%E7%BB%9C%E4%BF%9D%E6%8A%A4%E6%9D%A1%E4%BE%8B-UI?type=design&node-id=5-507&mode=design&t=v2dou196BOlTGSVW-0](https://www.figma.com/file/rMjzULLR9vyCy8nbwYo1g5/%23742320-%E6%9C%AA%E6%88%90%E5%B9%B4%E4%BA%BA%E7%BD%91%E7%BB%9C%E4%BF%9D%E6%8A%A4%E6%9D%A1%E4%BE%8B-UI?type=design&node-id=5-507&mode=design&t=v2dou196BOlTGSVW-0)                                                                                                                                                                      |
|wiki     |手机CC通用跳转协议：[https://km.netease.com/wiki/27/page/9880#%E6%89%AB%E4%B8%80%E6%89%AB](https://km.netease.com/wiki/27/page/9880#%E6%89%AB%E4%B8%80%E6%89%AB)

业务接口：[https://km.netease.com/team/cc_studio/wiki/page/417803](https://km.netease.com/team/cc_studio/wiki/page/417803)
人脸识别算法：[https://km.netease.com/wiki/937/page/384763](https://km.netease.com/wiki/937/page/384763)                                                                                                                                                                                                                          |
|排期     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|日志     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|耗时     |2+2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|备注     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

需求耗时评估

交互稿、UI稿、服务端wiki、服务端接口可测试时间、埋点是否有

|功能            |拆分                                                                                                                           |耗时评估(d)|
|----------------|-------------------------------------------------------------------------------------------------------------------------------|-----------|
|扫码调起识别流程|增加cclink、服务端接口对接                                                                                                     |0.5        |
|流程            |开播中流程

- 推送提示，若在后台，点击跳转app
- 验证提示弹窗、服务端接口对接
- 验证成功弹窗
- 验证失败弹窗、服务端接口对接

开播前流程|0.5

0.5

1
1   |
|人脸识别sdk     |录屏app迁移验证CC流程

- 推送提示，若在后台，点击跳转app
- 关播提示

录屏app接入sdk、服务端接口对接                                 |1          |
|联调            |                                                                                                                               |0.5        |

截图

|功能                                 |截图                                                                                                                                                                  |耗时|
|-------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|----|
|移动端开播增加人脸识别身份验证-开播前|![10d26f517c8c75d6febde4bbd939f459.png](image/10d26f517c8c75d6febde4bbd939f459.png)

![c533b52807dbd7c3e7ffea9d4e3312bb.png](image/c533b52807dbd7c3e7ffea9d4e3312bb.png)

|2   |
|移动端开播增加人脸识别身份验证-开播中|![4e103b265c021b99be20b6fc964a217e.png](image/4e103b265c021b99be20b6fc964a217e.png)

![9b31666a37eb920fedcb6be567051541.png](image/9b31666a37eb920fedcb6be567051541.png)

|2   |
