---
需求: "#758319 短视频-点赞&评论 https://icc.pm.netease.com/v6/issues/758319"
tags: 
需求文档: https://docs.popo.netease.com/team/pc/east/pageDetail/96ab09828b9f43f8adb10aec99ccb376
交互: https://mastergo.netease.com/file/121258275995217?page_id=0%3A29323&shareId=121258275995217
UI:
  - https://mastergo.netease.com/file/120797854650071?page_id=0%3A33513
wiki:
  - https://docs.popo.netease.com/lingxi/824c48a4867a42288f4afdc32c49aef1?tab=2&xyz=1710916756168
排期: 
日志: 
耗时: 
备注: 
分支: MainPageVideoFeed
publishTime: ""
---

>参考资料
> [CommentDialog](https://github.com/ArcGhh/CommentDialog)
> [Android 记录一下仿抖音评论列表 - 简书](https://www.jianshu.com/p/ab55f54658fa)


1. 评论入口
	美术 “评论” 与交互不一致，交互 “抢首评”有具体规则

2. 数据展示逻辑未定
	2/10/10， 3/5/5？
	下文描述  3/5/5

3. 图片评论是否支持
	交互：不支持评论，可支持表情
	文档：
	支持文字、表情（emoji?）、静态、GIF
	静态、GIF 预览
	---
	我以交互为准，不支持图片/gif；仅支持文字以及系统自支持的 emoji。
	

4. 回复不在第一条时，点击回复按钮，自动上移到顶部
5. 唤起评论时，视频区往上移动，需设定一个尺寸
6. 打开评论列表时，短视频上移，隐藏顶部 tab
7. 回复
	 评论上移
	 判断登录
	 
8. 发送成功、失败，点击操作浮层不同


---

### 已完成
#### 评论弹窗
- [ ] 底部加载更多状态
- [ ] 视频缩放优化
- [ ] 导航栏兼容
- [ ] 44116/208 联调
- [ ] 发送按钮有按压效果需要确认

#### 列表
- [ ] 列表 UI 细节、某人回复某人、加载状态
- [ ] 评论联调
- [x] 发送状态
- [ ] 长按弹窗
- [ ] 删除、举报

### 待确认
**交互**
1、发送空格内容是否给个 toast 提示？
2、`com.netease.cc.videofeed.mainpage.comment.PrimaryCommentViewHolder#clickReply`
这里的登录检查是否冗余。确认登录检查时机，长按出现操作弹窗点击了某一项再检查登录还是？
3、发送评论前会检查网络、内容是否为空，给个检查顺序
4、如果评论未展开情况下，用户评论了，新评论的这一条应该立即展示，其余还是折叠中
~~如果已经全部展开过，然后收起，再次点击展开还是按照 3、5、5 嘛还是展开上次已经展开过的~~



**服务端**
- [ ] 评论包含敏感词失败 需要提示"评论包含敏感词，请重新输入"。是否可以在 44116/201 回包 code!=0 , reason=“评论包含敏感词，请重新输入”
- [ ] 对评论进行了回复，replies 中有数据，但是"record": {"comment_num": 0}
- [ ] 发出评论，但 44116/201 回包是"\_id"，而不是预期的"id"
- [ ] IP 目前返回的都是未知
- [ ] 44116/201 发出评论，由于需要先加入到列表中显示发送中，等服务端数据回来后更新。看看是不是加个 clientId 字段，客户端在请求的时候带上去，服务端透传回来
- [ ] 44116/208 是客户端请求还是服务端广播？
- [ ] 评论的回复数量 `record.comment_num` 和 `replies` 大小不一致

---

#### BottomSheetDialogFragment
问题：[SmartRefreshLayout](https://github.com/scwang90/SmartRefreshLayout) 只能上拉，但是不能下拉，下拉的话 BottomSheetDialogFragment 会滑动关闭
```
https://github.com/scwang90/SmartRefreshLayout/issues/994
代码中设置
refreshLayout.setEnableNestedScroll(false)
或xml中给recycleview添加
app:srlEnableNestedScrolling="false"
```
禁用 RecycleView 的 isNestedScrollingEnabled


#### 软键盘
隐藏软键盘且不调整弹窗位置
``` kotlin
dialog?.window?.setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_HIDDEN or WindowManager.LayoutParams.SOFT_INPUT_ADJUST_NOTHING)
```

#### EditText

问题：EditText 需要点击两次才能响应 OnClick
如果不需要打开软键盘，设置 `isFocusable = false`，不加这个首次点击是获取焦点而不是响应 OnClick

问题：无法换行
```
得返回false，返回true会拦截回车
setOnEditorActionListener(TextView.OnEditorActionListener { v: TextView?, actionId: Int, event: KeyEvent? ->  
    if (actionId == EditorInfo.IME_ACTION_SEND) {  
        send()  
        return@OnEditorActionListener true  
    }  
    false  
})

```


#### recycleview

`srlEnableNestedScrolling`：关闭后，可解决与 BottomSheetDialogFragment 的滑动冲突
`srlEnableOverScrollBounce`：
```
<com.netease.cc.widget.refreshlayout.CCRecyclerViewRefreshLayout  
    android:id="@+id/refreshLayout"  
    android:layout_width="match_parent"  
    android:layout_height="0dp"  
    app:srlEnableNestedScrolling="false"  
    app:srlEnableRefresh="false"  
    app:srlEnableOverScrollBounce="false"  
    app:layout_constraintStart_toStartOf="parent"  
    app:layout_constraintEnd_toEndOf="parent"  
    app:layout_constraintTop_toBottomOf="@id/tvCommentNum"  
    app:layout_constraintBottom_toTopOf="@id/vContentBottom"/>
```


```
@Module
abstract class VideoFeedModule {

    @Binds
    @IntoMap
    @ServiceKey(IVideoFeedService::class)
    abstract fun videoFeedService(service: VideoFeedService): ComponentService


    @FraScope
    @ContributesAndroidInjector
    abstract fun videoFeedCommentFragment(): VideoFeedCommentDialogFragment
}


```